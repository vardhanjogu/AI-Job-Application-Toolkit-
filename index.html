<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Job Application Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        /* Custom scrollbar for textareas */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .loading-overlay {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">
                AI Job Application Toolkit
            </h1>
            <p class="text-gray-600 text-lg">
                Generate tailored cover letters and prepare for your interview using AI analysis.
            </p>
        </header>

        <div class="space-y-6">
            <!-- Input Card (Job Description & Resume) -->
            <div class="bg-white card rounded-xl p-6 md:p-8 border border-indigo-100">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">1. Provide Job & Candidate Details</h2>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Job Description Input -->
                    <div>
                        <label for="jobDescription" class="block text-sm font-medium text-gray-700 mb-2">
                            Paste the Job Description (JD) here:
                        </label>
                        <textarea id="jobDescription" rows="10" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="e.g., Senior Software Engineer - Must have 5 years experience in React and Node.js..."></textarea>
                    </div>

                    <!-- Resume Text Input -->
                    <div>
                        <label for="resumeText" class="block text-sm font-medium text-gray-700 mb-2">
                            Paste Your Full Resume Text Here:
                        </label>
                        <textarea id="resumeText" rows="10" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Copy and paste the entire text content of your resume/CV here..."></textarea>
                    </div>
                </div>

                <!-- Action Buttons (Updated to use flex-wrap for responsiveness) -->
                <div class="mt-8 flex flex-wrap justify-center gap-4">
                    <button onclick="generateCoverLetter()" id="generateBtn" class="flex-1 min-w-[200px] bg-indigo-600 text-white py-3 px-4 rounded-lg font-bold text-sm sm:text-lg hover:bg-indigo-700 transition duration-200 transform hover:scale-[1.01] disabled:bg-indigo-400 disabled:cursor-not-allowed">
                        Generate Cover Letter
                    </button>
                    <button onclick="extractKeySkills()" id="skillsBtn" class="flex-1 min-w-[200px] bg-green-500 text-white py-3 px-4 rounded-lg font-bold text-sm sm:text-lg hover:bg-green-600 transition duration-200 transform hover:scale-[1.01] disabled:bg-green-400 disabled:cursor-not-allowed">
                        ✨ Analyze JD & Extract Skills
                    </button>
                    <button onclick="summarizeJobDescription()" id="summaryBtn" class="flex-1 min-w-[200px] bg-teal-500 text-white py-3 px-4 rounded-lg font-bold text-sm sm:text-lg hover:bg-teal-600 transition duration-200 transform hover:scale-[1.01] disabled:bg-teal-400 disabled:cursor-not-allowed">
                        ✨ Summarize Role Mission
                    </button>
                    <button onclick="identifyResumeGaps()" id="gapsBtn" class="flex-1 min-w-[200px] bg-red-600 text-white py-3 px-4 rounded-lg font-bold text-sm sm:text-lg hover:bg-red-700 transition duration-200 transform hover:scale-[1.01] disabled:bg-red-400 disabled:cursor-not-allowed">
                        ✨ Identify Resume Gaps
                    </button>
                    <button onclick="generateInterviewQuestions()" id="questionsBtn" class="flex-1 min-w-[200px] bg-purple-600 text-white py-3 px-4 rounded-lg font-bold text-sm sm:text-lg hover:bg-purple-700 transition duration-200 transform hover:scale-[1.01] disabled:bg-purple-400 disabled:cursor-not-allowed">
                        ✨ Generate Interview Questions
                    </button>
                    <button onclick="draftStarResponseIdea()" id="starBtn" class="flex-1 min-w-[200px] bg-sky-500 text-white py-3 px-4 rounded-lg font-bold text-sm sm:text-lg hover:bg-sky-600 transition duration-200 transform hover:scale-[1.01] disabled:bg-sky-400 disabled:cursor-not-allowed">
                        ✨ Draft STAR Response Idea
                    </button>
                    <button onclick="draftFollowUpEmail()" id="emailBtn" class="flex-1 min-w-[200px] bg-yellow-600 text-white py-3 px-4 rounded-lg font-bold text-sm sm:text-lg hover:bg-yellow-700 transition duration-200 transform hover:scale-[1.01] disabled:bg-yellow-400 disabled:cursor-not-allowed">
                        ✨ Draft Follow-up Email
                    </button>
                </div>
            </div>

            <!-- Output Card -->
            <div class="bg-white card rounded-xl p-6 md:p-8 border border-indigo-100">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">2. AI-Generated Results</h2>
                
                <div id="errorAlert" class="hidden mb-6 p-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                    <span class="font-medium">Error:</span> <span id="errorMessage"></span>
                </div>

                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Cover Letter Output (Main Column) -->
                    <div class="lg:col-span-2 relative">
                        <h3 class="text-xl font-medium text-gray-800 mb-3 border-b pb-2">Custom Cover Letter Draft</h3>
                        <div id="loadingLetter" class="hidden loading-overlay absolute inset-0 flex items-center justify-center rounded-xl z-10">
                            <p class="mt-3 text-indigo-600 font-medium">Drafting letter...</p>
                        </div>
                        <div id="coverLetterOutput" class="min-h-64 h-full text-gray-700 whitespace-pre-wrap leading-relaxed border border-gray-200 p-4 rounded-lg bg-gray-50 italic">
                            Click 'Generate Cover Letter' to begin.
                        </div>
                    </div>

                    <!-- Supporting Outputs Container (Right Column) -->
                    <div class="lg:col-span-1 space-y-6">
                         <!-- JD Summary Output -->
                         <div class="relative">
                            <h3 class="text-xl font-medium text-gray-800 mb-3 border-b pb-2">Role Mission Summary</h3>
                            <div id="loadingSummary" class="hidden loading-overlay absolute inset-0 flex items-center justify-center rounded-xl z-10">
                                <p class="mt-3 text-teal-600 font-medium">Summarizing role...</p>
                            </div>
                            <div id="summaryOutput" class="min-h-32 text-gray-700 whitespace-pre-wrap leading-relaxed border border-gray-200 p-4 rounded-lg bg-teal-50 italic">
                                Click 'Summarize Role Mission' for results.
                            </div>
                        </div>

                        <!-- Key Skills Output -->
                        <div class="relative">
                            <h3 class="text-xl font-medium text-gray-800 mb-3 border-b pb-2">Key JD Skills</h3>
                            <div id="loadingSkills" class="hidden loading-overlay absolute inset-0 flex items-center justify-center rounded-xl z-10">
                                <p class="mt-3 text-green-600 font-medium">Extracting skills...</p>
                            </div>
                            <div id="skillOutput" class="min-h-32 text-gray-700 whitespace-pre-wrap leading-relaxed border border-gray-200 p-4 rounded-lg bg-green-50 italic">
                                Click 'Analyze JD & Extract Skills' for results.
                            </div>
                        </div>
                        
                        <!-- Resume Gaps Output (NEW) -->
                         <div class="relative">
                            <h3 class="text-xl font-medium text-gray-800 mb-3 border-b pb-2">Identified Resume Gaps</h3>
                            <div id="loadingGaps" class="hidden loading-overlay absolute inset-0 flex items-center justify-center rounded-xl z-10">
                                <p class="mt-3 text-red-600 font-medium">Identifying gaps...</p>
                            </div>
                            <div id="gapsOutput" class="min-h-32 text-gray-700 whitespace-pre-wrap leading-relaxed border border-gray-200 p-4 rounded-lg bg-red-100 italic">
                                Click 'Identify Resume Gaps' for critical feedback.
                            </div>
                        </div>

                        <!-- Interview Questions Output -->
                        <div class="relative">
                            <h3 class="text-xl font-medium text-gray-800 mb-3 border-b pb-2">Tailored Interview Questions</h3>
                            <div id="loadingQuestions" class="hidden loading-overlay absolute inset-0 flex items-center justify-center rounded-xl z-10">
                                <p class="mt-3 text-purple-600 font-medium">Generating questions...</p>
                            </div>
                            <div id="interviewOutput" class="min-h-32 text-gray-700 whitespace-pre-wrap leading-relaxed border border-gray-200 p-4 rounded-lg bg-purple-50 italic">
                                Click 'Generate Interview Questions' for prep.
                            </div>
                        </div>

                        <!-- STAR Response Output (NEW) -->
                        <div class="relative">
                            <h3 class="text-xl font-medium text-gray-800 mb-3 border-b pb-2">STAR Response Idea</h3>
                            <div id="loadingStar" class="hidden loading-overlay absolute inset-0 flex items-center justify-center rounded-xl z-10">
                                <p class="mt-3 text-sky-600 font-medium">Drafting STAR idea...</p>
                            </div>
                            <div id="starOutput" class="min-h-32 text-gray-700 whitespace-pre-wrap leading-relaxed border border-gray-200 p-4 rounded-lg bg-sky-50 italic">
                                Click 'Draft STAR Response Idea' for interview story help.
                            </div>
                        </div>
                        
                        <!-- Follow-up Email Output -->
                        <div class="relative">
                            <h3 class="text-xl font-medium text-gray-800 mb-3 border-b pb-2">Follow-up Email Template</h3>
                            <div id="loadingEmail" class="hidden loading-overlay absolute inset-0 flex items-center justify-center rounded-xl z-10">
                                <p class="mt-3 text-yellow-600 font-medium">Drafting email...</p>
                            </div>
                            <div id="emailOutput" class="min-h-32 text-gray-700 whitespace-pre-wrap leading-relaxed border border-gray-200 p-4 rounded-lg bg-yellow-50 italic">
                                Click 'Draft Follow-up Email' for a personalized template.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for API key and URL
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Utility function for exponential backoff
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { // Not a rate limit error
                        return response;
                    }
                    // Rate limit hit (429), wait and retry
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Wait before retrying on network errors
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("API request failed after multiple retries.");
        }

        /**
         * Converts a markdown text to HTML, specifically focusing on paragraphs and line breaks.
         */
        function formatMarkdownToHtml(markdownText) {
            // Replace double newlines with paragraph tags
            let htmlContent = markdownText.split('\n\n')
                .map(paragraph => `<p class="mb-4">${paragraph.trim()}</p>`)
                .join('');
            
            // Handle single newlines within paragraphs (like a line break)
            htmlContent = htmlContent.replace(/\n/g, '<br>');
            // Handle numbered lists (basic replacement)
            htmlContent = htmlContent.replace(/(\d+\.\s.*?)<br>/g, (match, p1) => `<p class="mb-2 ml-4">${p1}</p>`);

            return htmlContent;
        }

        function handleError(elementId, message, buttonId) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessageSpan = document.getElementById('errorMessage');
            
            errorMessageSpan.textContent = message;
            errorAlert.classList.remove('hidden');

            const outputDiv = document.getElementById(elementId);
            outputDiv.innerHTML = "Generation failed. See error message above.";
            outputDiv.classList.add('italic');
            
            if (buttonId) {
                document.getElementById(buttonId).disabled = false;
            }
        }

        function checkInputs() {
            const jobDescription = document.getElementById('jobDescription').value.trim();
            const resumeText = document.getElementById('resumeText').value.trim();
            
            if (!jobDescription || !resumeText) {
                handleError('coverLetterOutput', "Please provide both the Job Description and your Full Resume Text to proceed.", null);
                return false;
            }
            document.getElementById('errorAlert').classList.add('hidden');
            return { jobDescription, resumeText };
        }

        async function generateCoverLetter() {
            const inputs = checkInputs();
            if (!inputs) return;
            const { jobDescription, resumeText } = inputs;

            const outputDiv = document.getElementById('coverLetterOutput');
            const loadingIndicator = document.getElementById('loadingLetter');
            const generateBtn = document.getElementById('generateBtn');

            outputDiv.innerHTML = "Drafting letter...";
            outputDiv.classList.add('italic');
            loadingIndicator.classList.remove('hidden');
            generateBtn.disabled = true;

            const systemPrompt = `You are a professional career coach and copywriter. Your task is to write a highly tailored, engaging, and professional cover letter draft (maximum 4 paragraphs, 300 words). The letter MUST directly address the requirements in the Job Description, using the provided Full Resume Text to highlight relevant, matched skills and accomplishments. Do not include a date, signature, or address block. Start with a strong hook, and end with a clear statement of interest. Return only the letter text, no introductory phrases.`;
            
            const userQuery = `Job Description (JD): "${jobDescription}" Full Resume Text: "${resumeText}" Please generate the cover letter draft based on the above information.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(apiUrl, options);
                const result = await response.json();

                if (!response.ok) throw new Error(result.error?.message || `API error status: ${response.status}`);
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputDiv.innerHTML = formatMarkdownToHtml(generatedText);
                    outputDiv.classList.remove('italic');
                } else {
                    throw new Error("Received an empty or malformed response from the AI.");
                }

            } catch (error) {
                console.error("Gemini API Error (Cover Letter):", error);
                handleError('coverLetterOutput', `Cover Letter failed: ${error.message}`, 'generateBtn');
            } finally {
                loadingIndicator.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }

        async function extractKeySkills() {
            const inputs = checkInputs();
            if (!inputs) return;
            const { jobDescription } = inputs;

            const outputDiv = document.getElementById('skillOutput');
            const loadingIndicator = document.getElementById('loadingSkills');
            const skillsBtn = document.getElementById('skillsBtn');

            outputDiv.innerHTML = "Extracting skills...";
            outputDiv.classList.add('italic');
            loadingIndicator.classList.remove('hidden');
            skillsBtn.disabled = true;

            const systemPrompt = `You are a job market analyst. Analyze the provided Job Description (JD) and extract the 8 most essential and required skills, technologies, and keywords that the candidate MUST possess to be considered for the role. Present the results as a concise, numbered list (1-8). Do not include any introductory or concluding sentences. Only output the list.`;
            
            const userQuery = `Job Description: "${jobDescription}" Please extract the 8 key skills.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(apiUrl, options);
                const result = await response.json();

                if (!response.ok) throw new Error(result.error?.message || `API error status: ${response.status}`);
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputDiv.innerHTML = generatedText.replace(/\n/g, '<br>');
                    outputDiv.classList.remove('italic');
                } else {
                    throw new Error("Received an empty or malformed response from the AI.");
                }

            } catch (error) {
                console.error("Gemini API Error (Skills):", error);
                handleError('skillOutput', `Skill extraction failed: ${error.message}`, 'skillsBtn');
            } finally {
                loadingIndicator.classList.add('hidden');
                skillsBtn.disabled = false;
            }
        }

        async function summarizeJobDescription() {
            const inputs = checkInputs();
            if (!inputs) return;
            const { jobDescription } = inputs;

            const outputDiv = document.getElementById('summaryOutput');
            const loadingIndicator = document.getElementById('loadingSummary');
            const summaryBtn = document.getElementById('summaryBtn');

            outputDiv.innerHTML = "Summarizing role...";
            outputDiv.classList.add('italic');
            loadingIndicator.classList.remove('hidden');
            summaryBtn.disabled = true;

            const systemPrompt = `You are a concise executive summary writer. Your goal is to analyze the Job Description and write a single, professional paragraph (max 4 sentences) that defines the core mission, primary challenges, and expected impact of this role. Do not use generic phrases. Return only the summary.`;
            
            const userQuery = `Job Description: "${jobDescription}" Please generate the core mission summary.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(apiUrl, options);
                const result = await response.json();

                if (!response.ok) throw new Error(result.error?.message || `API error status: ${response.status}`);
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputDiv.innerHTML = formatMarkdownToHtml(generatedText);
                    outputDiv.classList.remove('italic');
                } else {
                    throw new Error("Received an empty or malformed response from the AI.");
                }

            } catch (error) {
                console.error("Gemini API Error (Summary):", error);
                handleError('summaryOutput', `Summary generation failed: ${error.message}`, 'summaryBtn');
            } finally {
                loadingIndicator.classList.add('hidden');
                summaryBtn.disabled = false;
            }
        }

        async function identifyResumeGaps() {
            const inputs = checkInputs();
            if (!inputs) return;
            const { jobDescription, resumeText } = inputs;

            const outputDiv = document.getElementById('gapsOutput');
            const loadingIndicator = document.getElementById('loadingGaps');
            const gapsBtn = document.getElementById('gapsBtn');

            outputDiv.innerHTML = "Identifying gaps...";
            outputDiv.classList.add('italic');
            loadingIndicator.classList.remove('hidden');
            gapsBtn.disabled = true;

            const systemPrompt = `You are a critical hiring manager. Your task is to compare the Job Description (JD) and the Full Resume Text and identify 3 to 4 specific areas (skills, experience length, technology, or domain knowledge) where the candidate's resume appears to be lacking or provides insufficient detail based on the JD's requirements. Present this as a bulleted list of weaknesses/gaps. Return only the list.`;
            
            const userQuery = `JD: "${jobDescription}" | Resume: "${resumeText}". Please identify the 4 biggest resume gaps or areas of weakness.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(apiUrl, options);
                const result = await response.json();

                if (!response.ok) throw new Error(result.error?.message || `API error status: ${response.status}`);
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputDiv.innerHTML = generatedText.replace(/^- /gm, '• ').replace(/\n/g, '<br>');
                    outputDiv.classList.remove('italic');
                } else {
                    throw new Error("Received an empty or malformed response from the AI.");
                }

            } catch (error) {
                console.error("Gemini API Error (Gaps):", error);
                handleError('gapsOutput', `Resume gap identification failed: ${error.message}`, 'gapsBtn');
            } finally {
                loadingIndicator.classList.add('hidden');
                gapsBtn.disabled = false;
            }
        }

        async function generateInterviewQuestions() {
            const inputs = checkInputs();
            if (!inputs) return;
            const { jobDescription, resumeText } = inputs;

            const outputDiv = document.getElementById('interviewOutput');
            const loadingIndicator = document.getElementById('loadingQuestions');
            const questionsBtn = document.getElementById('questionsBtn');

            outputDiv.innerHTML = "Generating questions...";
            outputDiv.classList.add('italic');
            loadingIndicator.classList.remove('hidden');
            questionsBtn.disabled = true;

            const systemPrompt = `You are an experienced interviewer. Based on the provided Job Description (JD) and Full Resume Text, generate 5 highly specific interview questions. Focus on questions that bridge the candidate's experience with the role's requirements. Include 1 behavioral question, 2 technical/scenario questions, and 2 questions focused on their past accomplishments matching the JD. Present the results as a numbered list (1-5). Do not include introductory or concluding sentences. Only output the list.`;
            
            const userQuery = `JD: "${jobDescription}" | Resume: "${resumeText}". Please generate the 5 tailored interview questions.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(apiUrl, options);
                const result = await response.json();

                if (!response.ok) throw new Error(result.error?.message || `API error status: ${response.status}`);
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputDiv.innerHTML = generatedText.replace(/\n/g, '<br>');
                    outputDiv.classList.remove('italic');
                } else {
                    throw new Error("Received an empty or malformed response from the AI.");
                }

            } catch (error) {
                console.error("Gemini API Error (Questions):", error);
                handleError('interviewOutput', `Question generation failed: ${error.message}`, 'questionsBtn');
            } finally {
                loadingIndicator.classList.add('hidden');
                questionsBtn.disabled = false;
            }
        }

        async function draftStarResponseIdea() {
            const inputs = checkInputs();
            if (!inputs) return;
            const { jobDescription, resumeText } = inputs;

            const outputDiv = document.getElementById('starOutput');
            const loadingIndicator = document.getElementById('loadingStar');
            const starBtn = document.getElementById('starBtn');

            outputDiv.innerHTML = "Drafting STAR idea...";
            outputDiv.classList.add('italic');
            loadingIndicator.classList.remove('hidden');
            starBtn.disabled = true;

            const systemPrompt = `You are a professional career coach. Your task is to analyze the Job Description and the Full Resume Text. Identify ONE crucial skill/requirement from the JD that the resume appears to have some experience in, and then draft a full STAR method (Situation, Task, Action, Result) template based on that potential match. Use placeholders in brackets (e.g., [Project Name]) for specific details the candidate must fill in. Structure the output clearly using S, T, A, R headings. Return only the structured template.`;
            
            const userQuery = `JD: "${jobDescription}" | Resume: "${resumeText}". Please draft a STAR response template based on a strong match.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(apiUrl, options);
                const result = await response.json();

                if (!response.ok) throw new Error(result.error?.message || `API error status: ${response.status}`);
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputDiv.innerHTML = generatedText.replace(/\n/g, '<br>');
                    outputDiv.classList.remove('italic');
                } else {
                    throw new Error("Received an empty or malformed response from the AI.");
                }

            } catch (error) {
                console.error("Gemini API Error (STAR):", error);
                handleError('starOutput', `STAR response drafting failed: ${error.message}`, 'starBtn');
            } finally {
                loadingIndicator.classList.add('hidden');
                starBtn.disabled = false;
            }
        }

        async function draftFollowUpEmail() {
            const inputs = checkInputs();
            if (!inputs) return;
            const { jobDescription, resumeText } = inputs;

            const outputDiv = document.getElementById('emailOutput');
            const loadingIndicator = document.getElementById('loadingEmail');
            const emailBtn = document.getElementById('emailBtn');

            outputDiv.innerHTML = "Drafting email...";
            outputDiv.classList.add('italic');
            loadingIndicator.classList.remove('hidden');
            emailBtn.disabled = true;

            const systemPrompt = `You are an AI assistant drafting a professional thank-you email template for a candidate after an interview. The email should be concise (max 3 short paragraphs), polite, and subtly reference their fit based on the Job Description and their Resume experience. Use placeholders like [Interviewer Name(s)], [Company Name], and [Specific Topic Discussed] in brackets. Return only the email body.`;
            
            const userQuery = `JD: "${jobDescription}" | Resume: "${resumeText}". Please draft the follow-up email template.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(apiUrl, options);
                const result = await response.json();

                if (!response.ok) throw new Error(result.error?.message || `API error status: ${response.status}`);
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputDiv.innerHTML = generatedText.replace(/\n/g, '<br>');
                    outputDiv.classList.remove('italic');
                } else {
                    throw new Error("Received an empty or malformed response from the AI.");
                }

            } catch (error) {
                console.error("Gemini API Error (Email):", error);
                handleError('emailOutput', `Email drafting failed: ${error.message}`, 'emailBtn');
            } finally {
                loadingIndicator.classList.add('hidden');
                emailBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
